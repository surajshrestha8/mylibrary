{% extends 'shelf/base.html' %}

{% block body %}

{% if messages %}
   
 
   
{% for message in messages %}
<div class="card-body">


<div class="alert alert-{{ message.tags }}" role="alert">
 <strong>Message:</strong> {{ message }}
 <button type="button" class="close" data-dismiss="alert" aria-label="Close">
   <span aria-hidden="true">&times;</span>
 </button>
 </div> 
</div>

  
{% endfor %}

{% endif %}
<div class="container" style="padding-top: 20px;" id="main">
  <div class="row">
      <div class="col-md-2">

      </div>
      <div class="col-md-8">
      <div class="card card-primary">
          <div class="card-header">
              <h3>Issue Book </h3>
          </div>
          <div class="card-body register-card-body">
            
            <form method="post" id="insert_form" shelf-url="{% url 'books:loadshelf' %}" student-url="{% url 'books:checkbooks' %}" action="{% url 'books:issuebook' %}">
              {% csrf_token %}
             
              <select class ="aform_control" aria-label="Default select example" name="student_username" id="student_username" required>
                <option selected>Select a student</option>
                {% for student in students %}
                <option  value="{{student.id}}">{{student.user.first_name}} {{student.user.last_name}}</option>
                {% endfor %}
              </select> 
           
              <hr>
            
            <div class="table-repsonsive">
              <span id="error"></span>
              <table class="table table-bordered" id="item_table">
                <thead>
                  <tr>
                   
                    <th>Book</th>
                    <th>Shelf</th>
                    <th><button type="button" name="add" class="btn btn-success btn-xs add"><span class="glyphicon glyphicon-plus"></span></button></th>
                  </tr>
                </thead>
                <tbody class="tablebody"></tbody>
                <span class="error_books" style="font-size:12px;color: red;"></span>
              </table>
              </div>
              <div>
                <button type="submit" name="submit" class="btn btn-success">Issue </button>
              </div>
            </div>
          </form>
        </div>
        </div>
        </div>
        </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" />
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script>
        



        
        $(document).ready(function(){


          var totalBooksDue;

          $(document).on('change', '#student_username', function() {
            var student_id = $(this).val();
            var url = $("#insert_form").attr("student-url");
            
            $.ajax({

              type: "GET",
              url:url,
              data: {
                'student_username': student_id

              },
              dataType:'json',
              success:function(data){
                totalBooksDue = data;
                
              },
              
            
          });
          
        });
          
          var count = 0;
    
          $(document).on('click', '.add', function(){
            var bookAmount = $(".tablebody").children().length;
            if(bookAmount<=(2-totalBooksDue)){
          
            count++;
            var html = '';
            html += '<tr>';
           
            html += '<td><select name="books_list[]"  required class="form-control item_category" data-sub_category_id="'+count+'"><option selected>Select a book</option>{% for book in books %}<option value="{{book.id}}">{{book.title}}</option>{% endfor %}</select></td>';
            html += '<td><select name="books_shelf[]"  required class="form-control item_sub_category" id="item_sub_category'+count+'">{% for shelf in shelves %}<option value="{{shelf.shelf.shelf_id}}">{{shelf.shelf.shelf_name}}</option>{% endfor %}</select></td>';
            html += '<td><button type="button" name="remove" class="btn btn-danger btn-xs remove"><span class="glyphicon glyphicon-minus"></span></button></td>';
            $('tbody').append(html);
            }
           else{

              $('.error_books').html("You cannot issue more books to this user");
             
           }

          });
    
          $(document).on('click', '.remove', function(){
            $(this).closest('tr').remove();
          });
    
          $(document).on('change', '.item_category', function(){
            var books_id = $(this).val();
            var url = $("#insert_form").attr("shelf-url");
            var sub_category_id = $(this).data('sub_category_id');
            $.ajax({
              url:url,
          
              data:{
                'books':books_id
              },
              success:function(data)
              {
                var html = '<option value="">Select shelf</option>';
                html += data;
                $('#item_sub_category'+sub_category_id).html(html);
              }
            })
          });

   
     
          
        });
    </script>


{% endblock %}

